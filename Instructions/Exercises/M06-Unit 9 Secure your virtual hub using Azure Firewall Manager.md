---
Exercise:
  title: M06 - 단원 9 Azure Firewall Manager를 사용하여 가상 허브 보호
  module: Module 06 - Design and implement network security
---


# M06-단원 9 Azure Firewall Manager를 사용하여 가상 허브 보호

## 연습 시나리오

이 연습에서는 스포크 가상 네트워크를 만들고 보안 가상 허브를 만든 다음, 허브 및 스포크 가상 네트워크를 연결하고 트래픽을 허브로 라우팅합니다. 그런 다음 워크로드 서버를 배포하고, 방화벽 정책을 만들고, 허브를 보호하고, 마지막으로 방화벽을 테스트합니다.

![보안 허브를 사용하는 가상 네트워크 아키텍처 다이어그램.](../media/9-exercise-secure-your-virtual-hub-using-azure-firewall-manager.png)

### 대화형 랩 시뮬레이션

**참고**: 이전에 제공되었던 랩 시뮬레이션은 사용 중지되었습니다.


## 허브 및 스포크 아키텍처 만들기

이 연습 부분에서는 워크로드 서버를 저장할 스포크 가상 네트워크 및 서브넷을 만듭니다. 그런 다음 보안 가상 허브를 만들고 허브 및 스포크 가상 네트워크를 연결합니다.

### 작업 기술

이 연습에서 다음을 수행합니다.

+ 작업 1: 2개의 스포크 가상 네트워크 및 서브넷 만들기
+ 작업 2: 보안 가상 허브 만들기
+ 작업 3: 허브 및 스포크 가상 네트워크 연결
+ 작업 4: 서버 배포
+ 작업 5: 방화벽 정책 만들기 및 허브 보안
+ 작업 6: 방화벽 정책 연결
+ 작업 7: 허브로 트래픽 라우팅
+ 작업 8: 애플리케이션 규칙 테스트
+ 작업 9: 네트워크 규칙 테스트
+ 작업 10: 리소스 정리

### 예상 시간: 35분

## 작업 1: 2개의 스포크 가상 네트워크 및 서브넷 만들기

이 작업에서는 각각 워크로드 서버를 호스트하는 서브넷을 포함하는 두 개의 스포크 가상 네트워크를 만듭니다.

1. Azure Portal에서 `Virtual Networks`를 검색하여 선택합니다.

1. **만들기**를 실행합니다.

1. **리소스 그룹**에서 **새로 만들기**를 선택하고 이름으로 `fw-manager-rg`를 입력한 후 **확인**을 선택합니다.

1. **가상 네트워크 이름**에 `Spoke-01`을 입력합니다.

1. **지역**에서 지역을 선택합니다.

1. **다음**을 선택합니다. **보안** 탭을 검토하기만 하고 변경하지 마세요. 

1. **다음**을 선택하고 **IP 주소** 탭으로 이동합니다.

1. **주소 공간 삭제**를 선택한 다음, **IPv4 주소 공간 추가**를 선택합니다. 

1. IP 주소 공간이 **10.0.0.0/16**인지 확인합니다.

1. **서브넷 추가**를 선택합니다. 

1. 서브넷 **이름**을 `Workload-01-SN`으로 변경합니다.

1. **시작 주소**를 `10.0.1.0`으로 변경합니다.

1. **추가**를 선택합니다.

1. **검토 + 만들기**를 선택합니다.

1. **만들기**를 선택합니다.

다음 정보를 사용하여 위의 1~14단계를 반복하여 유사한 가상 네트워크와 서브넷을 하나 더 만듭니다. 첫 번째 가상 네트워크가 배포를 완료할 때까지 기다릴 필요가 없습니다. 

+ 리소스 그룹: **fw-manager-rg**(기존 그룹 선택)
+ 가상 네트워크 이름: `Spoke-02`
+ 주소 공간: **10.1.0.0/16** - (기타 나열된 주소 공간 모두 삭제)
+ 서브넷 이름: `Workload-02-SN`
+ 서브넷 시작 주소: `10.1.1.0`

## 작업 2: 보안 가상 허브 만들기

이 작업에서는 Firewall Manager를 사용하여 보안 가상 허브를 만듭니다.

1. 포털에서 `firewall manager`를 검색한 다음, **네트워크 보안 키워드 방화벽 관리자**를 선택합니다.
   
1. **리소스 보호** 블레이드에서 **가상 허브**를 선택합니다.

1. **보안 가상 허브 새로 만들기**를 선택합니다.

1. **리소스 그룹**에 대해 **fw-manager-rg**를 선택합니다.

1. **지역**에서 지역을 선택합니다.

1. **보안 가상 허브 이름**으로 `Hub-01`을 입력합니다.

1. **허브 주소 공간`10.2.0.0/16`으로 **을 입력합니다.

1. **새 vWAN**이 선택되어 있는지 확인합니다.

1. **Virtual WAN 이름**으로 `Vwan-01`을 입력합니다.

1. **다음: Azure Firewall**을 선택합니다. 검토만 하고 변경하지는 마세요. 

1. **다음: 보안 파트너 공급자**를 선택합니다. 검토만 하고 변경하지는 마세요. 

1. **다음: 검토 + 만들기**를 선택합니다.

1. **만들기**를 실행합니다.

    > 참고: 배포하는 데 최대 30분이 걸릴 수 있습니다.

1. 배포가 완료될 때가지 기다립니다. 

1. 포털에서 `firewall manager`를 검색한 다음, **네트워크 보안 키워드 방화벽 관리자**를 선택합니다.

1. **Firewall Manager** 페이지에서 **가상 허브**를 선택합니다.

1. **Hub-01**을 선택합니다.

1. **Azure Firewall**을 선택한 다음, **공용 IP 구성**을 선택합니다.

1. 나중에 사용할 공용 IP 주소(예: **172.191.79.203**)를 기록해 두세요.

## 작업 3: 허브 및 스포크 가상 네트워크 연결

이 작업에서는 허브 및 스포크 가상 네트워크를 연결합니다. 일반적으로 이를 피어링이라고 합니다.

1. 포털에서 `Vwan-01` 가상 WAN을 검색하여 선택합니다.

1. **연결**에서 **가상 네트워크 연결**을 선택합니다.

1. **연결 추가**를 선택합니다.

1. **연결 이름**으로 `hub-spoke-01`을 입력합니다.

1. **허브**에 대해 **Hub-01**을 선택합니다.

1. **리소스 그룹**에 대해 **fw-manager-rg**를 선택합니다.

1. **가상 네트워크**에 대해 **Spoke-01**을 선택합니다.

1. **만들기**를 실행합니다.

1. 위의 4~9단계를 반복하여 다른 유사한 연결을 만들지만 연결 이름 `hub-spoke-02`를 사용하여 **Spoke-02** 가상 네트워크를 연결합니다.

1. 가상 네트워크 연결 페이지를 **새로 고치고** Spoke-01 및 Spoke-02의 두 가상 네트워크가 있는지 확인합니다.
   
## 작업 4: 서버 배포

1. Azure Portal 오른쪽 상단에 있는 Cloud Shell 아이콘을 선택합니다. 필요한 경우 셸을 구성합니다.  
    + **PowerShell**을 선택합니다.
    + **스토리지 계정이 필요하지 않음**과 **구독**을 선택한 다음 **적용**을 선택합니다.
    + 터미널이 생성되고 프롬프트가 표시될 때까지 기다립니다. 

1. Cloud Shell 창의 도구 모음에서 **파일 관리** 아이콘을 선택하고 드롭다운 메뉴에서 **업로드**를 선택한 후 **FirewallManager.json** 및 **FirewallManager.parameters.json** 파일을 Cloud Shell 홈 디렉토리에 업로드합니다.

    > **참고:** 사용자 구독으로 작업하는 경우 [템플릿 파일](https://github.com/MicrosoftLearning/AZ-700-Designing-and-Implementing-Microsoft-Azure-Networking-Solutions/tree/master/Allfiles/Exercises)은 GitHub 랩 리포지토리에서 사용할 수 있습니다.

1. 다음 ARM 템플릿을 배포하여 이 연습에 필요한 VM을 만듭니다.

   >**참고**: 관리 암호를 입력하라는 메시지가 표시됩니다. **이 암호는 이후 단계에서 필요합니다.**

   ```powershell
   $RGName = "fw-manager-rg"
   
   New-AzResourceGroupDeployment -ResourceGroupName $RGName -TemplateFile FirewallManager.json -TemplateParameterFile FirewallManager.parameters.json
   ```
  
1. 배포가 완료되면 Azure Portal 홈페이지로 이동한 다음 **가상 머신**을 선택합니다.

1. **Srv-workload-01**의 **개요** 페이지에서 오른쪽 창의 **네트워킹** 섹션 아래에 있는 **개인 IP 주소**(예: **10.0.1.4**)를 기록해 둡니다.

1. **Srv-workload-02**의 **개요** 페이지에서 오른쪽 창의 **네트워킹** 섹션 아래에 있는 **개인 IP 주소**(예: **10.1.1.4**)를 기록해 둡니다.

## 작업 5: 방화벽 정책 만들기 및 허브 보안

이 작업에서는 먼저 방화벽 정책을 만든 다음 허브의 보안을 유지합니다. 방화벽 정책은 하나 이상의 보안 가상 허브에서 트래픽을 전달하는 규칙 컬렉션을 정의합니다.

1. 포털에서 `Firewall Policies`를 검색하여 선택합니다.

1. **만들기**를 실행합니다.

    | **설정**    | **값** |
    | ---------- | --------------|
    | Resource group | **fw-manager-rg** |
    | 속성    | `Policy-01` |
    | 지역     | 지역 선택 |
    | 정책 계층 | **Standard** |

1. **다음: DNS 설정**을 선택합니다. 검토만 하고 변경하지는 마세요. 

1. **다음: TLS 검사**를 선택합니다. 검토만 하고 변경하지는 마세요. 

**Microsoft 도메인을 허용하는 규칙 컬렉션 및 규칙을 추가합니다.**

1. **다음: 규칙**을 선택한 다음, **규칙 컬렉션 추가**를 선택합니다.

   | **설정** | **값** |
   | ---------- | --------------|
   | 속성        |  `App-RC-01` |
   | 규칙 컬렉션 유형 | **애플리케이션** |
   | 우선 순위    | `100` |
   | 규칙 컬렉션 작업 | **허용** |

1. **규칙** 섹션에서 다음이 적용됩니다.

   | **설정** | **값** |
   | ---------- | --------------|
   | 속성 |  `Allow-msft` |
   | 소스 형식 | **IP 주소** |
   | 원본 | `*` |
   | 프로토콜 | `http,https` |
   | 대상 형식 | **FQDN** |
   | 대상 | `*.microsoft.com` |

**Srv-workload-01 가상 머신에 대한 원격 데스크톱 연결을 허용하는 규칙 컬렉션 및 규칙을 추가합니다.**

1. **규칙 컬렉션 추가**를 선택합니다.

   | **설정** | **값** |
   | ---------- | --------------|
   | 속성        |  `dnat-rdp` |
   | 규칙 컬렉션 유형 | **DNAT** |
   | 우선 순위    | `100` |
   | 규칙 컬렉션 작업 | **허용** |

1. **규칙** 섹션에서 다음이 적용됩니다.

   | **설정** | **값** |
   | ---------- | --------------|
   | 속성 |  `Allow-rdp` |
   | 소스 형식 | **IP 주소** |
   | 원본 | `*` |
   | 프로토콜 | **TCP** |
   | 대상 포트 | `3389` |
   | 대상(방화벽 IP 주소) | 방화벽 가상 허브 공용 IP 주소 입력 |
   | 변환된 형식 | **IP 주소** |
   | 변환된 주소 또는 FQDN | Srv-workload-01 가상 머신의 개인 IP 주소 입력 |
   | 번역된 포트 | `3389` |
   
**Srv-workload-02 가상 머신에 대한 원격 데스크톱 연결을 허용하는 규칙 컬렉션 및 규칙을 추가합니다.**

1. **규칙 컬렉션 추가**를 선택합니다.

   | **설정** | **값** |
   | ---------- | --------------|
   | 속성        |  `vnet-rdp` |
   | 규칙 컬렉션 유형 | **Network** |
   | 우선 순위    | `100` |
   | 규칙 컬렉션 작업 | **허용** |

1. **규칙** 섹션에서 다음이 적용됩니다.

   | **설정** | **값** |
   | ---------- | --------------|
   | 속성 |  `Allow-vnet` |
   | 소스 형식 | **IP 주소** |
   | 원본 | `*` |
   | 프로토콜 | **TCP** |
   | 대상 포트 | `3389` |
   | 대상(방화벽 IP 주소) | 방화벽 가상 허브 공용 IP 주소 입력 |
   | 변환된 형식 | **IP 주소** |
   | 변환된 주소 또는 FQDN | Srv-workload-02 가상 머신의 개인 IP 주소 입력 |
   | 번역된 포트 | `3389` |

1. **추가**를 선택합니다.

1. 세 개의 규칙 컬렉션이 있는지 확인합니다.

1. **검토 + 만들기**를 선택합니다.

1. **만들기**를 선택합니다.

## 작업 6: 방화벽 정책 연결

이 작업에서는 방화벽 정책을 가상 허브와 연결합니다.

1. 포털에서 `Hub-01`을 검색하여 선택합니다.

1. **설정** 블레이드에서 **보안 공급자**를 선택하세요.

1. **정책 추가** 확인란을 선택하세요.

1. **Policy-01**을 선택한 다음, **저장**을 선택하세요.

1. **Hub-01**에 대한 확인란을 선택합니다.

1. **추가**를 선택합니다.

1. 정책이 연결되면 **새로 고침**을 선택합니다. 연결이 표시됩니다.

## 작업 7: 허브로 트래픽 라우팅

이제 네트워크 트래픽이 방화벽을 통해 라우팅되는지 확인해야 합니다.

1. 포털에서 **Vwan-01**을 검색하여 선택하세요.

1. **연결** 블레이드에서 **허브**를 선택한 다음, **Hub-01**을 선택하세요.
   
1. **보안** 블레이드에서 **Azure Firewall 및 Firewall Manager**를 선택하고 **Hub-01**을 선택한 다음, **보안 구성**을 선택하세요.

1. **인터넷 트래픽**에서 **Azure Firewall**을 선택합니다.

1. **프라이빗 트래픽**에서 **Azure Firewall을 통해 보내기**를 선택합니다.

1. **저장**을 선택하고 **확인**을 클릭하여 선택한 항목을 확인하세요.

1. 작업을 완료하는 데 몇 분 정도 걸립니다.

1. 구성이 완료되면 **인터넷 트래픽** 및 **프라이빗 트래픽** 아래에서 허브-스포크 연결 모두에 대해 **Azure Firewall로 보호됨**이 표시되는지 확인합니다.

## 작업 8: 애플리케이션 규칙 테스트

연습의 이 부분에서는 원격 데스크톱을 Srv-Workload-01로 NAT된 방화벽 공용 IP 주소에 연결합니다. 그런 다음 웹 브라우저를 사용하여 애플리케이션 규칙을 테스트하고 원격 데스크톱을 Srv-Workload-02에 연결하여 네트워크 규칙을 테스트합니다.

이 작업에서는 애플리케이션 규칙을 테스트하여 예상대로 작동하는지 확인합니다.

1. PC에서 **원격 데스크톱 연결**을 엽니다.

1. **컴퓨터** 상자에 **방화벽의 공용 IP 주소**(예: **51.143.226.18**)를 입력합니다.

1. **옵션 표시**를 선택합니다.

1. **사용자 이름** 상자에 **TestUser**를 입력합니다.

1. **연결**을 선택합니다.

   ![RDP를 srv-workload-01에 연결](../media/rdp-srv-workload-01.png)

1. **사용자 인증 정보 입력** 대화 상자에서 배포 시 제공한 암호를 사용하여 **Srv-workload-01** 서버 가상 머신에 로그인합니다.

1. **확인**을 선택합니다.

1. 인증서 메시지에서 **예**를 선택합니다.

1. Internet Explorer를 열고 **Internet Explorer 11 설정** 대화 상자에서 **확인**을 선택합니다.

1. `https://www.microsoft.com`으로 이동합니다.

1. **보안 경고** 대화 상자에서 **확인**을 선택합니다.

1. Internet Explorer 보안 경고가 나타나면 **닫기**를 선택합니다.

1. Microsoft 홈페이지가 표시됩니다.

    ![RDP 세션 microsoft.com 검색](../media/microsoft-home-page.png)

1. **https://** **<www.google.com>** 으로 이동합니다.

1. 방화벽에서 차단해야 합니다.

    ![RDP 세션 google.com에서 브라우저가 차단됨](../media/google-home-page-fail.png)

1. 허용된 하나의 FQDN에 연결할 수 있지만 다른 모든 것으로부터 차단된다는 것을 확인했습니다.

## 작업 9: 네트워크 규칙 테스트

이 작업에서는 네트워크 규칙을 테스트하여 예상대로 작동하는지 확인합니다.

1. **Srv-workload-01** RDP 세션에 로그인하는 동안 이 원격 컴퓨터에서 **원격 데스크톱 연결**을 엽니다.

1. **컴퓨터** 상자에 **Srv-workload-02**의 **개인 IP 주소**(예: **10.1.1.4**)를 입력합니다.

1. **사용자 인증 정보 입력** 대화 상자에서 사용자 이름 **TestUser**와 배포 중에 제공한 암호를 사용하여 **Srv-workload-02** 서버에 로그인합니다.

1. **확인**을 선택합니다.

1. 인증서 메시지에서 **예**를 선택합니다.

   ![srv-workload-01의 RDP 세션에서 srv-workload-02의 다른 RDP 세션으로](../media/rdp-srv-workload-02-from-srv-workload-01.png)

1. 한 서버에서 다른 가상 네트워크에 있는 다른 서버로 원격 데스크톱을 연결한 후 방화벽 네트워크 규칙이 작동하는 것을 확인했습니다.

1. 두 RDP 세션을 모두 닫고 연결을 끊습니다.

## 작업 10: 리소스 정리

>**참고**: 더 이상 사용하지 않는 새로 만든 Azure 리소스는 모두 제거하세요. 사용되지 않는 리소스를 제거하면 예기치 않은 요금이 발생하지 않습니다.

1. Azure Portal의 **Cloud Shell** 창에서 **PowerShell** 세션을 엽니다.

1. 다음 명령을 실행하여 이 모듈의 랩 전체에서 만든 모든 리소스 그룹을 삭제합니다.

   ```powershell
   Remove-AzResourceGroup -Name 'fw-manager-rg' -Force -AsJob
   ```

   >**참고**: 이 명령은 -AsJob 매개 변수에 의해 결정되어 비동기로 실행되므로, 동일한 PowerShell 세션 내에서 이 명령을 실행한 직후 다른 PowerShell 명령을 실행할 수 있지만 리소스 그룹이 실제로 제거되기까지는 몇 분 정도 걸립니다.
